---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getDictionary, isLocale } from '../../../i18n';
import type { Locale } from '../../../i18n/config';
import { getEntryBySlug, getCollection } from 'astro:content';

export const prerender = true;

const { params } = Astro;
const lang = (params.lang ?? 'en') as Locale;
if (!isLocale(lang)) {
  throw new Error(`Unknown locale: ${params.lang}`);
}

const dict = await getDictionary(lang);

// 期望的 slug 形如 "my-post"
const slug = params.slug as string;

// 先按 slug 精确查找
let post = await getEntryBySlug('blog', slug);

// 若内容在子目录中，CI 传入的 slug 可能只是不含路径的尾段；做一次兜底匹配
if (!post) {
  const all = await getCollection('blog');
  post = all.find((p) => p.slug.split('/').pop() === slug);
}

// 找不到就回到该语言的博客列表，避免预览报错
if (!post) {
  return Astro.redirect(`/${lang}/blog/`);
}

// 渲染内容
const { Content, data } = await post.render();
---

<BaseLayout {dict} lang={lang} title={data?.title}>
  <article class="prose">
    <Content />
  </article>
</BaseLayout>
