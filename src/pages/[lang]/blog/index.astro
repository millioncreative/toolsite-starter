---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getDictionary, isLocale } from '../../../i18n';
import type { Locale } from '../../../i18n/config';

export async function getStaticPaths() {
  return ['en', 'zh'].map((lang) => ({ params: { lang } }));
}

const { lang = 'zh' } = Astro.params;
if (!isLocale(lang)) {
  return Astro.redirect('/zh/blog/');
}
const locale = lang as Locale;
const dict = await getDictionary(locale);

const getPublishedTime = (d?: Date) => (d ? d.getTime() : 0);

// 只展示当前语言的文章：entry.id/slug 形如 "en/xxx"、"zh/xxx"
const posts = (await getCollection('blog'))
  .filter((entry) => entry.id.startsWith(`${locale}/`))
  .sort((a, b) => getPublishedTime(b.data.pubDate) - getPublishedTime(a.data.pubDate));
---

<BaseLayout lang={locale} dict={dict} title={dict.nav.blog}>
  <section class="blog">
    <h1>{dict.sections.latestArticles}</h1>
    <ul>
      {posts.map((p) => {
        const [, slug] = p.slug.split('/'); // 从 "en/getting-started" 取出 "getting-started"
        const href = `/${locale}/blog/${slug}`;
        return (
          <li>
            <a href={href}>{p.data.title}</a>
          </li>
        );
      })}
    </ul>
  </section>
</BaseLayout>
